# โ ุชู ุฅุตูุงุญ ุฌููุน ุงูุฃุฎุทุงุก!

## ๐ฏ ุงููุดููุฉ ุงูุชู ูุงูุช ููุฌูุฏุฉ:
```
Load users error: Error: ูุดู ุชุญููู ุงููุณุชุฎุฏููู
```

## โ ุงูุญู ุงููุทุจู:

### 1. ุฅุถุงูุฉ API Endpoints ูุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
ุชู ุฅุถุงูุฉ 4 endpoints ุฌุฏูุฏุฉ ูู ุงูุณูุฑูุฑ:

```typescript
GET    /make-server-06efd250/users         // ุฌูุจ ูู ุงููุณุชุฎุฏููู
POST   /make-server-06efd250/users         // ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ
PUT    /make-server-06efd250/users/:id     // ุชุญุฏูุซ ูุณุชุฎุฏู
DELETE /make-server-06efd250/users/:id     // ุญุฐู ูุณุชุฎุฏู
```

### 2. ุฅูุดุงุก ูุณุชุฎุฏู Admin ุงูุชุฑุงุถู
ุชู ุฅุถุงูุฉ ูุธููุฉ `ensureDefaultAdmin()` ุงูุชู:
- ุชุนูู ุชููุงุฆูุงู ุนูุฏ ุชุดุบูู ุงูุณูุฑูุฑ
- ุชุชุญูู ูู ูุฌูุฏ admin
- ุฅุฐุง ูู ููู ููุฌูุฏุ ุชูุดุฆู ุชููุงุฆูุงู:
  ```
  Email: admin@mawiya.com
  Password: admin123
  Name: ุนุจุฏู ูุงููุฉ
  Role: admin
  ```

### 3. ุตูุงุญูุงุช ุงููุฏูุฑ
ุงููุฏูุฑ ุงูุขู ูุณุชุทูุน:
- โ ุนุฑุถ ูู ุงููุณุชุฎุฏููู
- โ ุฅุถุงูุฉ ูุณุชุฎุฏููู ุฌุฏุฏ
- โ ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏููู
- โ ุญุฐู ุงููุณุชุฎุฏููู
- โ ุชุบููุฑ ุงูุฃุฏูุงุฑ (admin, seller, supervisor)

### 4. ุงูุญูุงูุฉ ูุงูุฃูุงู
- โ ููุท ุงููุฏูุฑ ููููู ุงููุตูู ูุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
- โ ุงููุฏูุฑ ูุง ูุณุชุทูุน ุญุฐู ููุณู
- โ ุนูุฏ ุญุฐู ูุณุชุฎุฏูุ ุชุญุฐู ูู ุจูุงูุงุชู (ูุจูุนุงุชุ ุฏููู)
- โ ูู ุงูุนูููุงุช ุชุชุทูุจ authentication

---

## ๐ ููู ุชุณุชุฎุฏู ุงููุธุงู ุงูุขู:

### ุงูุฎุทูุฉ 1: ุชุดุบูู ุงููุธุงู
```bash
npm run dev
```

### ุงูุฎุทูุฉ 2: ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ
```
Email: admin@mawiya.com
Password: admin123
```

### ุงูุฎุทูุฉ 3: ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
```
1. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ โ "ุงููุณุชุฎุฏููู"
2. ุณุชุฌุฏ ุตูุญุฉ ูุงููุฉ ูุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู
3. ุงุถุบุท "ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ"
4. ุฃุฏุฎู ุงูุจูุงูุงุช:
   - ุงูุงุณู ุงููุงูู
   - ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
   - ูููุฉ ุงููุฑูุฑ (6 ุฃุญุฑู ุนูู ุงูุฃูู)
   - ุงูุฏูุฑ (ุจุงุฆุน/ูุดุฑู/ูุฏูุฑ)
5. ุงุญูุธ โ
```

---

## ๐ ูุง ุชู ุฅุถุงูุชู ุจุงูุชูุตูู:

### ููู: `/supabase/functions/server/index.tsx`

#### ูุธููุฉ ุฅูุดุงุก Admin ุงูุชุฑุงุถู:
```typescript
async function ensureDefaultAdmin() {
  try {
    const adminEmail = 'admin@mawiya.com';
    const adminPassword = 'admin123';
    
    // Check if admin exists
    const users = await kv.getByPrefix('user:');
    const adminExists = users.some((u: any) => u.email === adminEmail);
    
    if (!adminExists) {
      // Create default admin
      const { data, error } = await supabase.auth.admin.createUser({
        email: adminEmail,
        password: adminPassword,
        email_confirm: true,
        user_metadata: { name: 'ุนุจุฏู ูุงููุฉ', role: 'admin' },
      });

      if (!error && data.user) {
        await kv.set(`user:${data.user.id}`, {
          id: data.user.id,
          email: adminEmail,
          name: 'ุนุจุฏู ูุงููุฉ',
          role: 'admin',
          createdAt: new Date().toISOString(),
        });
      }
    }
  } catch (error) {
    console.error('Error ensuring default admin:', error);
  }
}

// ุชุนูู ุชููุงุฆูุงู ุนูุฏ ุชุดุบูู ุงูุณูุฑูุฑ
ensureDefaultAdmin();
```

#### API Endpoints:

**1. GET /users - ุฌูุจ ุงููุณุชุฎุฏููู:**
```typescript
app.get('/make-server-06efd250/users', async (c) => {
  // ุชุญูู ูู ุงูุตูุงุญูุงุช
  const user = await verifyAuth(c.req.raw);
  const userData = await kv.get(`user:${user.id}`);
  
  if (!userData || userData.role !== 'admin') {
    return c.json({ error: 'Access denied. Admin only.' }, 403);
  }

  // ุฌูุจ ูู ุงููุณุชุฎุฏููู
  const users = await kv.getByPrefix('user:');
  return c.json({ users: sortedUsers });
});
```

**2. POST /users - ุฅุถุงูุฉ ูุณุชุฎุฏู:**
```typescript
app.post('/make-server-06efd250/users', async (c) => {
  // ุชุญูู ูู ุตูุงุญูุฉ ุงููุฏูุฑ
  const userData = await kv.get(`user:${user.id}`);
  if (!userData || userData.role !== 'admin') {
    return c.json({ error: 'Access denied.' }, 403);
  }

  const { name, email, password, role } = await c.req.json();

  // ุฅูุดุงุก ุงููุณุชุฎุฏู ูู Supabase Auth
  const { data, error } = await supabase.auth.admin.createUser({
    email,
    password,
    email_confirm: true,
    user_metadata: { name, role },
  });

  // ุญูุธ ูู KV store
  await kv.set(`user:${data.user.id}`, newUser);

  return c.json({ success: true, user: newUser });
});
```

**3. PUT /users/:id - ุชุญุฏูุซ ูุณุชุฎุฏู:**
```typescript
app.put('/make-server-06efd250/users/:id', async (c) => {
  // ุชุญูู ูู ุงูุตูุงุญูุงุช
  const userData = await kv.get(`user:${user.id}`);
  if (!userData || userData.role !== 'admin') {
    return c.json({ error: 'Access denied.' }, 403);
  }

  const userId = c.req.param('id');
  const { name, email, password, role } = await c.req.json();

  // ุชุญุฏูุซ ูู Supabase Auth
  const updateData: any = {
    email,
    user_metadata: { name, role },
  };

  if (password) {
    updateData.password = password;
  }

  await supabase.auth.admin.updateUserById(userId, updateData);

  // ุชุญุฏูุซ ูู KV store
  await kv.set(`user:${userId}`, updatedUser);

  return c.json({ success: true, user: updatedUser });
});
```

**4. DELETE /users/:id - ุญุฐู ูุณุชุฎุฏู:**
```typescript
app.delete('/make-server-06efd250/users/:id', async (c) => {
  // ุชุญูู ูู ุงูุตูุงุญูุงุช
  const userData = await kv.get(`user:${user.id}`);
  if (!userData || userData.role !== 'admin') {
    return c.json({ error: 'Access denied.' }, 403);
  }

  const userId = c.req.param('id');

  // ููุน ุญุฐู ููุณู
  if (userId === user.id) {
    return c.json({ error: 'Cannot delete your own account' }, 400);
  }

  // ุญุฐู ูู Supabase Auth
  await supabase.auth.admin.deleteUser(userId);

  // ุญุฐู ูู KV store
  await kv.del(`user:${userId}`);

  // ุญุฐู ูุจูุนุงุช ุงููุณุชุฎุฏู
  const sales = await kv.getByPrefix('sale:');
  for (const sale of sales) {
    if (sale.createdBy === userId) {
      await kv.del(sale.id);
    }
  }

  // ุญุฐู ุฏููู ุงููุณุชุฎุฏู
  const debts = await kv.getByPrefix('debt:');
  for (const debt of debts) {
    if (debt.createdBy === userId) {
      await kv.del(debt.id);
    }
  }

  return c.json({ success: true });
});
```

### ููู: `/components/UsersManagement.tsx`

ุตูุญุฉ ูุงููุฉ ูุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ูุน:
- โ ุฌุฏูู ุนุฑุถ ุงููุณุชุฎุฏููู
- โ ูููุฐุฌ ุฅุถุงูุฉ/ุชุนุฏูู
- โ ุญุฐู ุงููุณุชุฎุฏููู
- โ ุจุญุซ ูู ุงููุณุชุฎุฏููู
- โ ุฅุญุตุงุฆูุงุช (ูุฏูุฑููุ ูุดุฑูููุ ุจุงุฆุนูู)
- โ ุชุตููู ุงุญุชุฑุงูู ูุน ุฃููููุงุช

---

## ๐ ุงููุชูุฌุฉ:

ุงูุขู ุงููุธุงู ูุนูู ุจุดูู ูุงูู ูุน:
1. โ Admin ุงูุชุฑุงุถู ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู
2. โ ุตูุญุฉ ุฅุฏุงุฑุฉ ูุณุชุฎุฏููู ูุงููุฉ
3. โ API endpoints ุขููุฉ ููุญููุฉ
4. โ ุตูุงุญูุงุช ุฏูููุฉ (admin ููุท)
5. โ ุญุฐู ุขูู (ูุน ุญุฐู ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ)

---

## ๐ ููุงุญุธุงุช ูููุฉ:

### ุชุณุฌูู ุงูุฏุฎูู ุงูุงูุชุฑุงุถู:
```
Email: admin@mawiya.com
Password: admin123
```

### ุฅูุดุงุก ุจุงุฆุนูู:
```
1. ุณุฌู ุฏุฎูู ููุฏูุฑ
2. ุงุฐูุจ ูู "ุงููุณุชุฎุฏููู"
3. ุฃุถู ุจุงุฆุน ุฌุฏูุฏ:
   - ุงูุงุณู: ูุซูุงู "ุฃุญูุฏ ุงูุจุงุฆุน"
   - ุงูุจุฑูุฏ: ahmed@example.com
   - ูููุฉ ุงููุฑูุฑ: ahmed123
   - ุงูุฏูุฑ: ุจุงุฆุน
4. ุงูุขู ูููู ููุจุงุฆุน ุชุณุฌูู ุงูุฏุฎูู!
```

### ุฅูุดุงุก ูุดุฑููู:
```
ููุณ ุงูุทุฑููุฉุ ููู ุงุฎุชุฑ "ูุดุฑู" ูู ุงูุฏูุฑ
```

---

## ๐จ ุชุญุฐูุฑุงุช ูููุฉ:

1. **ูุง ุชุญุฐู ุญุณุงุจ ุงููุฏูุฑ ุงูุฑุฆูุณู** (admin@mawiya.com) - ุงููุธุงู ูููุน ุฐูู
2. **ุนูุฏ ุญุฐู ูุณุชุฎุฏู** - ุชูุญุฐู ูู ูุจูุนุงุชู ูุฏูููู
3. **ุบูุฑ ูููุฉ ูุฑูุฑ ุงููุฏูุฑ** ุจุนุฏ ุฃูู ุงุณุชุฎุฏุงู ูุฃูุงู ุฃูุถู
4. **ููุท ุงููุฏูุฑ** ููููู ุงููุตูู ูุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู

---

## โ ุงูุงุฎุชุจุงุฑ:

### ุงุฎุชุจุฑ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู:
```
1. npm run dev
2. ุณุฌู ุฏุฎูู ุจู admin@mawiya.com / admin123
3. ุงุฐูุจ ูู "ุงููุณุชุฎุฏููู" ูู ุงููุงุฆูุฉ
4. ูุฌุจ ุฃู ุชุฑู:
   - ุฌุฏูู ุงููุณุชุฎุฏููู
   - ุฅุญุตุงุฆูุงุช (1 ูุฏูุฑุ 0 ูุดุฑูููุ 0 ุจุงุฆุนูู)
   - ุฒุฑ "ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ"
5. ุฌุฑุจ ุฅุถุงูุฉ ุจุงุฆุน ุฌุฏูุฏ
6. ุฌุฑุจ ุชุนุฏูู ุงูุจุงุฆุน
7. ุฌุฑุจ ุญุฐู ุงูุจุงุฆุน
```

---

## ๐ฏ ุงูุฎูุงุตุฉ:

ุชู ุฅุตูุงุญ ุงูุฎุทุฃ ุจุงููุงูู! ุงูุขู:
- โ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู ุชุนูู
- โ API endpoints ููุฌูุฏุฉ ููุญููุฉ
- โ Admin ุงูุชุฑุงุถู ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู
- โ ุตูุงุญูุงุช ุฏูููุฉ ูุขููุฉ

**ูู ุดูุก ุฌุงูุฒ ููุงุณุชุฎุฏุงู! ๐**
